# Claude Capsule Kit Integration

This project uses **Claude Capsule Kit** - a persistent context memory system for Claude Code that enables cross-message and cross-session memory.

## üéØ System Overview

Claude Capsule Kit provides:
- **Persistent Context**: Remember files accessed, tasks worked on, and discoveries made
- **Smart Refresh**: Automatic context updates before each prompt
- **Cross-Session Memory**: Context persists across sessions (24-hour window)
- **Sub-Agent Tracking**: Remember findings from specialized agents
- **Discovery Logging**: Capture architectural insights and patterns

## üö® CRITICAL: Directory Structure

**NEVER CREATE NEW TOOLS/HOOKS/SCRIPTS IN `.claude/` DIRECTORY!**

### Source vs. Installed Files

```
tools/                    ‚Üí SOURCE code (packaged, committed to git)
  ‚îú‚îÄ‚îÄ progressive-reader/ ‚Üí Tool source + install.sh
  ‚îî‚îÄ‚îÄ progressive-reader-wrapper/ ‚Üí Wrapper scripts + tool.json

.claude/                  ‚Üí INSTALLED runtime files (generated, NOT committed)
  ‚îú‚îÄ‚îÄ tools/             ‚Üí Installed copies from tools/
  ‚îú‚îÄ‚îÄ hooks/             ‚Üí Installed copies from hooks/
  ‚îî‚îÄ‚îÄ lib/               ‚Üí Installed libraries
```

### Rule of Thumb

**When creating NEW tools, wrappers, hooks, or scripts:**
- ‚úÖ CREATE in root directories: `tools/`, `hooks/`, `scripts/`
- ‚ùå DO NOT create in `.claude/` - this is for installed files only
- `.claude/` contents are GENERATED by install script
- Only modify `.claude/` when testing/debugging, then copy changes back to source

**Example:**
```bash
# CORRECT - Create wrapper in source location
tools/progressive-reader-wrapper/
  ‚îú‚îÄ‚îÄ progressive-reader.sh
  ‚îî‚îÄ‚îÄ tool.json

# WRONG - Creating in installed location
.claude/tools/progressive-reader/  ‚ùå DON'T DO THIS!
```

---

## üìñ Core Usage Guide

**IMPORTANT**: Read `.claude/docs/CAPSULE_USAGE_GUIDE.md` for complete workflow examples.

### Required Workflow Pattern

```
1. CHECK CAPSULE ‚Üí See what context already exists
2. WORK ‚Üí Use specialized tools and agents
3. LOG ‚Üí Persist discoveries for future sessions
```

**Check Before Work**:
```bash
cat .claude/capsule.toon  # Session state
bash .claude/tools/memory-graph/memory-query.sh --recent 10  # Historical knowledge
```

**Logging Pattern**:
```bash
# After file operations
bash .claude/hooks/log-file-access.sh "<path>" "read|edit|write"

# After sub-agent use
bash .claude/hooks/log-subagent.sh "<agent-type>" "<summary>"

# After discoveries
bash .claude/hooks/log-discovery.sh "<category>" "<insight>"
# Categories: pattern, insight, decision, architecture, bug, optimization
```

See: `.claude/docs/CAPSULE_USAGE_GUIDE.md` for detailed examples

---

## ‚ö° Tool Selection Quick Reference

**MANDATORY**: Use specialized tools, enforced by PreToolUse hook.

| Task | Tool | Command |
|------|------|---------|
| What imports file X? | `query-deps` | `bash .claude/tools/query-deps/query-deps.sh <file>` |
| What breaks if I change X? | `impact-analysis` | `bash .claude/tools/impact-analysis/impact-analysis.sh <file>` |
| Circular dependencies? | `find-circular` | `bash .claude/tools/find-circular/find-circular.sh` |
| Dead code? | `find-dead-code` | `bash .claude/tools/find-dead-code/find-dead-code.sh` |
| Find files by name | `Glob` | `Glob(pattern="**/*auth*")` |
| Find code patterns | `Grep` | `Grep(pattern="function.*login")` |
| Read large files (>50KB) | `progressive-reader` | `$HOME/.claude/bin/progressive-reader --path <file> --list` |

**NEVER use Task/Explore for**: Dependencies, file search, code search

See: `docs/TOOL_ENFORCEMENT_REFERENCE.md` for complete guide

---

## ü§ñ Agent Selection Quick Reference

**Principle**: Use the RIGHT agent for each task.

| Task Type | Agent | Model |
|-----------|-------|-------|
| Errors/bugs (RCA) | `error-detective` | Opus |
| Debugging (systematic) | `debugger` | Opus |
| Code review | `code-reviewer` | Sonnet |
| Refactoring | `refactoring-specialist` | Opus |
| How does X work? | `architecture-explorer` | Sonnet |
| Database schema | `database-navigator` | Sonnet |
| Security analysis | `security-engineer` | Opus |
| Git conflicts | `git-workflow-manager` | Sonnet |
| Production issues | `devops-sre` | Sonnet |
| Design decisions | `brainstorm-coordinator` | Sonnet |

**Total**: 17 agents available

**Parallel Spawning**: For complex tasks, spawn multiple agents in PARALLEL (single message, multiple Task calls)

See: `docs/AGENT_ROUTING_GUIDE.md` for complete routing guide

---

## üöÄ Workflow Skills (NEW)

**Systematic workflows for complex tasks**:

| Skill | Triggers | Purpose |
|-------|----------|---------|
| **`/workflow`** | complex, multi-step, coordinate | 5-phase systematic approach |
| **`/debug`** | error, bug, broken, failing | RCA-first debugging |
| **`/deep-context`** | don't have context, understand codebase | 6-layer context building |
| **`/code-review`** | review, check code (manual) | Pre-commit quality gate |

**Auto-activation**: Skills auto-load based on trigger keywords

**Manual invocation**: `/skill-name` (e.g., `/workflow`, `/debug`)

See: Skills menu (`/skills` command) for all available skills

---

## üìö Complete Documentation

**Core Guides**:
- `.claude/docs/CAPSULE_USAGE_GUIDE.md` - Complete usage patterns, logging commands, workflow examples

**Reference Docs**:
- `docs/TOOL_ENFORCEMENT_REFERENCE.md` - Detailed tool selection guide, progressive-reader workflows
- `docs/AGENT_ROUTING_GUIDE.md` - All 17 agents, routing rules, parallel spawning patterns
- `docs/BEST_PRACTICES.md` - Best practices, anti-patterns, success metrics

**Architecture**:
- `docs/SUPER_CLAUDE_SYSTEM_ARCHITECTURE.md` - Overall system design
- `docs/PROGRESSIVE_READER_ARCHITECTURE.md` - Progressive-reader internals
- `docs/DEPENDENCY_GRAPH_ARCHITECTURE.md` - Dependency analysis system
- `docs/SKILLS_ORCHESTRATION_ARCHITECTURE.md` - Skills + hooks design
- `docs/CAPSULE_DEGRADATION_RCA.md` - Context retention analysis

---

## üéØ Quick Start

1. **Install**: Run install script (creates `.claude/` directory)
2. **Work**: Use Claude normally
3. **Check capsule**: `cat .claude/capsule.toon` to see session state
4. **Use skills**: `/workflow` for complex tasks, `/debug` for errors
5. **Use tools**: `query-deps`, `impact-analysis`, `progressive-reader`
6. **Use agents**: Launch specialists for deep work (parallel when possible)

**First value**: Immediate (capsule tracks your session from message 1)

---

## üí° Key Behaviors (Remember These)

### BEFORE Work:
- Check `.claude/capsule.toon` for session context
- Query `memory-graph` for historical knowledge
- Use `progressive-reader` for large files (>50KB)

### DURING Work:
- Use specialized tools (query-deps, not Task/Explore)
- Launch agents for deep work (error-detective, architecture-explorer)
- Spawn agents in PARALLEL when independent

### AFTER Work:
- Log file access, sub-agent findings, discoveries
- Persist knowledge to memory-graph
- Update capsule automatically (hooks handle this)

---

**These are REQUIRED workflows, not suggestions. Follow them consistently.**
